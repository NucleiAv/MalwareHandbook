# Dynamic Analysis

## Pre Dynamic Analysis

<figure><img src="../../.gitbook/assets/Untitled 58.png" alt=""><figcaption></figcaption></figure>

## lets begin

We need to know what kind of application this is via PE bear.

<figure><img src="../../.gitbook/assets/Untitled 59.png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/Untitled 60.png" alt=""><figcaption></figcaption></figure>

Make sure of your user privileges. Working with user privileges and root ones can yield to different outputs and results. Or may be the malware is abusing some sort of privilege escalation.

Now the command in powershell, `.\Ultima.exe.crow` .

```powershell
#RESULT
←[38;5;196m???    ??   ??           ???      ??    ???????????      ?????????
???    ??? ???       ??????????? ???  ???????????????   ???    ???
???    ??? ???          ???????? ???? ???   ???   ???   ???    ???
???    ??? ???           ???   ? ???? ???   ???   ???   ???    ???
???    ??? ???           ???     ???? ???   ???   ??? ????????????
???    ??? ???           ???     ???  ???   ???   ???   ???    ???
???    ??? ????    ?     ???     ???  ???   ???   ???   ???    ???
?????????  ?????????    ??????   ??    ??   ???   ??    ???    ??

←[0m←[38;5;240m[08:19:39] ←[0m[←[38;5;154m+←[0m] Operation Ultima, Final Weapon. v16.8
←[38;5;240m[08:19:39] ←[0m[←[38;5;117mi←[0m] Beginning initialization...
←[38;5;240m[08:19:39] ←[0m[←[38;5;117mi←[0m] Attempting to read value from Computer\HKEY_CURRENT_USER\Console\VirtualTerminalLevel...
←[38;5;240m[08:19:39] ←[0m[←[38;5;203m!←[0m] Computer\HKEY_CURRENT_USER\Console\VirtualTerminalLevel wasn't found!
←[38;5;240m[08:19:39] ←[0m[←[38;5;203m!←[0m] It seems like ANSI is disabled for you, recruit. What did we say about disabling ANSI? That's 40 days in the dungeon for you.
←[38;5;240m[08:19:39] ←[0m[←[38;5;117mi←[0m] Enabling ansi support for command prompt...
←[38;5;240m[08:19:39] ←[0m[←[38;5;154m+←[0m] Registry key and value created successfully. Terminal restart required.
←[38;5;240m[08:19:39] ←[0m[←[38;5;154m+←[0m] Heh. We'll take care of that for you. See ya 'round, initiate.
←[38;5;240m[08:19:39] ←[0m[←[38;5;117mi←[0m] Exiting...
```

So this malware is attempting too read value from `Computer\HKEY_CURRENT_USER\Console\VirtualTerminalLevel` . Not knowing these is no harm, so we search ‘ _VirtualTerminalLevel ‘ ._ On searching this, we get the following from below site.

[Use ANSI colors in the terminal - Windows CMD - SS64.com](https://ss64.com/nt/syntax-ansi.html)

<figure><img src="../../.gitbook/assets/Untitled 61.png" alt=""><figcaption></figcaption></figure>

So the malware is basically trying to enable ANSI. And that’s why our polite malware informs us regarding the same as well.

<figure><img src="../../.gitbook/assets/Untitled 62.png" alt=""><figcaption></figcaption></figure>

Now it also says that Registry key and value created. So for this we use Procmon - Process Monitor. Procmon is a tool which, for a given process, we can see the operations the process does.

<figure><img src="../../.gitbook/assets/Untitled 63.png" alt=""><figcaption></figcaption></figure>

For instance we see, explorer.exe. opening a key to path - HKLM. Hence we can filter it to get better info. So we filter and include the process of ‘Ultima.exe’, so that we can monitor it.

<figure><img src="../../.gitbook/assets/Untitled 64.png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/Untitled 65.png" alt=""><figcaption></figcaption></figure>

Now off to Registry Editor, we come to the path where key is set i.e. the VirtualTerminalLevel, We see that it is already set.

<figure><img src="../../.gitbook/assets/Untitled 66.png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/Untitled 67.png" alt=""><figcaption></figcaption></figure>

So we will have to close our terminal, then restart it, in order to delete/reallocate/re-set. Run command `cls` in powershell. We get a butt-load of information in Procmon.

<figure><img src="../../.gitbook/assets/Untitled 68.png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/Untitled 69.png" alt=""><figcaption></figcaption></figure>

We also see that VirtualTerminalLevel was not found (Both shown by Procmon and Malware). So it creates that key and sets it to 1. Since the key is set to 1, now by again executing ‘Ultima.exe’ with Admin. It gives a better colored o/p and asks for User and Password. Thanks to Static Analysis and Notes that we know a user and corresponding password.

<figure><img src="../../.gitbook/assets/Untitled 70.png" alt=""><figcaption></figcaption></figure>

If we give wrong user, password pair, we seem to get 3 chances to give correct pair.

<figure><img src="../../.gitbook/assets/Untitled 71.png" alt=""><figcaption></figcaption></figure>

So when we execute with right creds, Gaius van Baelsar, its a reference to a game - Final Fantasy XIV

<figure><img src="../../.gitbook/assets/Untitled 72.png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/Untitled 73.png" alt=""><figcaption></figcaption></figure>

After this we go back to Procmon to check if we get something more useful. This marks the end of our analysis. Our final malware folder comprises of the following

<figure><img src="../../.gitbook/assets/Untitled 74.png" alt=""><figcaption></figcaption></figure>
